{% extends "barcode/base.html" %}
{% block header %}
  <!-- for the file browser -->
  <style type="text/css" media="screen">@import "/site_media/css/jqueryFileTree.css";</style>
  <style type="text/css">@import "/site_media/css/containers.css";</style>
  <script type="text/javascript" src="/site_media/js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="/site_media/js/jqueryFileTree.js"></script>
  <script type="text/javascript" src="/site_media/js/visibility.js"></script>
</head>
{% endblock %}

{% block content %}

<div id="title">&nbsp;{% include "barcode/noscript.html" %}</div>

{% if error_message %}
    {% autoescape off %}
    <span class="red"><b>{{ error_message }}</b></span>
    {% endautoescape %}
{% endif %}

<form name="entryform" method="post" action="" enctype="multipart/form-data">

<div class="container" id="entry_form">
<table align="left" width="100%">
  <tr align="left">
    <td align="right"><b>{{ recordform.company.label }}:</b>{{ recordform.company.errors }}</td>
    <td>{{ recordform.company }}</td>
  </tr>
  <tr align="left">
    <td align="right"><b>{{ recordform.website.label }}:</b>{{ recordform.website.errors }}</td>
    <td>{{ recordform.website }}</td>
  </tr>
  <tr align="left">
    <td align="right"><b>{{ recordform.product.label }}:</b>{{ recordform.product.errors }}</td>
    <td>{{ recordform.product }}</td>
  </tr>
  <tr align="left">
    <td align="right"><b>{{ recordform.version.label }}:</b>{{ recordform.version.errors }}</td>
    <td>{{ recordform.version }}</td>
  </tr>
  <tr align="left">
    <td align="right"><b>{{ recordform.release.label }}:</b>{{ recordform.release.errors }}</td>
    <td>{{ recordform.release }}</td>
  </tr>
  <tr align="left">
    <td align="right"><b>{{ recordform.contact.label }}:</b></td>
    <td>{{ recordform.contact }}</td>
    <td align="center" colspan="2"><input style="width: 200px" type="submit" name="submit_qrcode" value="Create Checksum/QRcode" /></td>
  </tr>
  <tr align="left">
    <td align="right"><b>{{ recordform.email.label }}:</b>{{ recordform.email.errors }}</td>
    <td>{{ recordform.email }}</td>   
    <td align="center" colspan="2"><input style="width: 200px" type="submit" name="submit_barcode" value="Create Checksum/Barcode" /></td>
  </tr>      
</table>
</div> <!-- entry_form -->

<div class="container" id="target_select" style="display: none;"> 
	<div id="target" class="browser"></div> 
</div>

<div class="foss_table">
<table border="1" width="700" cellspacing="1" style='table-layout:fixed' id="foss_list">
    <col width=125>
    <col width=60>
    <col width=120>
    <col width=120>
    <col width=60>
    <col width=145>
    <col width=145>
    <col width=120>
    <col width=80>
    <col width=145>
    <col width=120>
  <tr>
    <th>FOSS Component</th>
    <th>Version</th>
    <th>Copyright<br>Information</th>
    <th>Attribution<br>Notices</th>
    <th>License</th>
    <th>License<br>URL</th>
    <th>Original<br>Download URL</th>
    <th colspan=2>SPDX<sup>TM</sup>File<br>(optional)</th>
    <th>Patches<br>(if applicable)</th>  
    <td></td>
  </tr>
  <tr>
    <!-- needed to control the width here, so hand tweaked size in css -->
    <td>{{ recordform.foss_component }}</td>
    <td>{{ recordform.foss_version }}</td>
    <td>{{ recordform.foss_copyright }}</td>
    <td>{{ recordform.foss_attribution }}</td>
    <td>{{ recordform.foss_license }}</td>
    <td>{{ recordform.foss_license_url }}</td>
    <td>{{ recordform.foss_url }}</td>
    <td>{{ recordform.foss_spdx }}</td>
    <td align="center"><input type="button" name="addspdx" 
                                        value="Select" 
                                        onclick=""/></td>
    <td align="center" colspan="2"><input type="button" name="addfoss" 
                                        value="Add Component" 
                                        onclick="get_foss_values();add_foss_row('foss_list', 'add')"/></td>
  </tr>
<!-- TODO - loop and fill this from SPDX, plus user can manually add bits, buttons to add patches -->
</table>
</div> <!-- foss_table -->

<input type="hidden", name="foss_components", id="foss_components", value="{{ foss_components }}">
<input type="hidden", name="foss_versions", id="foss_versions", value="{{ foss_versions }}">
<input type="hidden", name="foss_copyrights", id="foss_copyrights", value="{{ foss_copyrights }}">
<input type="hidden", name="foss_attributions", id="foss_attributions", value="{{ foss_attributions }}">
<input type="hidden", name="foss_licenses", id="foss_licenses", value="{{ foss_licenses }}">
<input type="hidden", name="foss_license_urls", id="foss_license_urls", value="{{ foss_license_urls }}">
<input type="hidden", name="foss_urls", id="foss_urls", value="{{ foss_urls }}">
<input type="hidden", name="foss_spdxs", id="foss_spdxs", value="{{ foss_spdxs }}">
<input type="hidden", name="foss_patches", id="foss_patches", value="{{ foss_patches }}">


</form>

<div class="cfooter">
<hr>
<b>Subscribe to the <a href="https://lists.linux-foundation.org/mailman/listinfo/foss-barcode-dev">mailing list</a></b><br>
<b>Get latest version from <a href="http://git.linuxfoundation.org/?p=foss-barcode.git;a=summary">git</a></b><br>
<b>Report bugs and request features at <a href="http://bugs.linuxfoundation.org/enter_bug.cgi?product=Compliance">bugzilla</a></b><br>
</div>

{% endblock %}

{% block scripts %}
<script language="JavaScript">
    var path_dest = "";
    var foss_name = "";
    var foss_copyright = "";
    var foss_attribution = "";
    var foss_version = "";
    var foss_license = "";
    var foss_license_url = "";
    var foss_url = "";
    var foss_spdx = "";

    $(document).ready( function() {
        $('#target').fileTree({
            root: '/',
            script: '/barcode/dirlist/',
            loadMessage: 'waiting to load'
            }, function(file) {
                filenametoentry(file);
        });
    });
    function setdefaults() {
        // if the user submitted with missing data, we lose the FOSS table content, repopulate
        if (document.getElementById("foss_components").value != "") {
            var fossn = document.getElementById("foss_components").value.split(",");
            var fossv = document.getElementById("foss_versions").value.split(",");
            var fossc = document.getElementById("foss_copyrights").value.split(",");
            var fossa = document.getElementById("foss_attributions").value.split(",");
            var fossl = document.getElementById("foss_licenses").value.split(",");
            var fosslu = document.getElementById("foss_license_urls").value.split(",");
            var fossu = document.getElementById("foss_urls").value.split(",");
            var fosss = document.getElementById("foss_spdxs").value.split(",");
            var fossp = document.getElementById("foss_patches").value.split(",");
            for (i = 0; i < fossn.length - 1; i++) {
                foss_name = fossn[i];
                foss_version = fossv[i];
                foss_copyright = fossc[i];
                foss_attribution = fossa[i];
                foss_license = fossl[i];
                foss_license_url = fosslu[i]
                foss_url = fossu[i];
                foss_spdx = fosss[i];
                add_foss_row("foss_list", "reload");
                patch_tag = "patch_files" + i;
                document.getElementsByName(patch_tag)[0].value = fossp[i];
            }
        }
    }
    function set_destination(dest) {
        path_dest = dest;
    }
    function toggle_enabled(button) {
        var e = document.getElementsByName(button)[0];
        if (e.disabled == true)
            e.disabled = false;
        else
            e.disabled = true;     
    }
    function filenametoentry(filename) {
        lastchar = filename.slice(-1);
        // only files, no dirs
        if (lastchar != '/') {
                document.getElementsByName(path_dest)[0].value += filename + "\n";
        }
    }
    function get_foss_values() {
        foss_name = document.getElementsByName("foss_component")[0].value;
        foss_version = document.getElementsByName("foss_version")[0].value;
        foss_license = document.getElementsByName("foss_license")[0].value;
        foss_url = document.getElementsByName("foss_url")[0].value;       
    }
    function add_foss_row(id, mode){
   
        if (foss_name.value == "" || foss_version.value == "")
            return;
        var tbody = document.getElementById(id).getElementsByTagName("TBODY")[0];
        var rindex = document.getElementById(id).rows.length - 2;
        var patch_tag = "patch_files" + rindex;
        var row = document.createElement("TR");
        
        var td1 = document.createElement("TD");
        td1.setAttribute("valign", "top");
        td1.appendChild(document.createTextNode(foss_name));
        row.appendChild(td1);

        var td2 = document.createElement("TD");
        td2.setAttribute("valign", "top");
        td2.appendChild (document.createTextNode(foss_version));
        row.appendChild(td2);

        var td3 = document.createElement("TD");
        td3.setAttribute("valign", "top");
        td3.appendChild (document.createTextNode(foss_license));
        row.appendChild(td3);

        var td4 = document.createElement("TD");
        td4.setAttribute("valign", "top");
        td4.appendChild (document.createTextNode(foss_license_url));
        row.appendChild(td4);

        var td5 = document.createElement("TD");
        td5.setAttribute("valign", "top");
        td5.appendChild (document.createTextNode(foss_copyright));
        row.appendChild(td5);

        var td6 = document.createElement("TD");
        td6.setAttribute("valign", "top");
        td6.appendChild (document.createTextNode(foss_attribution));
        row.appendChild(td6);

        var td7 = document.createElement("TD");
        td7.setAttribute("valign", "top");
        td7.appendChild (document.createTextNode(foss_url));
        row.appendChild(td7);

        var td8 = document.createElement("TD");
        td8.setAttribute("valign", "top");
        td8.setAttribute("colspan", "2");
        td8.appendChild (document.createTextNode(foss_spdx));
        row.appendChild(td8);
   
        // list of patches
        var td9 = document.createElement("TD");        
        var ch9 = document.createElement("textarea");
        ch9.setAttribute("type", "textarea");
        ch9.setAttribute("name",patch_tag);
        td9.appendChild(ch9);   
        row.appendChild(td9);

        // buttons for file selectors
        var td10 = document.createElement("TD");
        td10.setAttribute("align", "center");
        var ch10 = document.createElement("input");
        ch10.setAttribute("type", "button");
        ch10.setAttribute("value", "Select\nPatch(es)");
        ch10.setAttribute("onclick", "toggle_visibility('target_select');set_destination('" + patch_tag + "')");
        ch10.setAttribute("name","patchfilename");
        ch10.setAttribute("title", "Open a File/Directory Selector");
        td10.appendChild(ch10);
        row.appendChild(td10);
        
        tbody.appendChild(row);

        // only set the hidden fields for a clean add, not a form reload
        // FIXME - need new fields here
        if (mode == "add") {
            document.getElementById("foss_components").value += foss_name + ",";
            document.getElementById("foss_versions").value += foss_version + ",";
            document.getElementById("foss_licenses").value += foss_license + ",";
            document.getElementById("foss_urls").value += foss_url + ",";
            // clean the input fields
            document.getElementsByName("foss_component")[0].value = "";
            document.getElementsByName("foss_version")[0].value = "";
            document.getElementsByName("foss_license")[0].value = "";
            document.getElementsByName("foss_url")[0].value = "";   
        }

        // cleanup the global vars
        foss_name = "";
        foss_version = "";
        foss_license = "";
        foss_url = "";
    }
</script>

{% endblock %}

