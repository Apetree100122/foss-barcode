{% extends "barcode/base.html" %}
{% block header %}
  <!-- for the file browser -->
  <style type="text/css" media="screen">@import "/site_media/css/jqueryFileTree.css";</style>
  <style type="text/css" media="screen">@import "/site_media/css/containers.css";</style>
  <!-- CSS file for the datepicker -->
  <style type="text/css" media="screen">@import "/site_media/css/jquery-ui-1.8.16.custom.css";</style>
  <!-- CSS file for modal dialog -->
  <style type="text/css" media="screen">@import "/site_media/css/barcode-modals.css";</style>
  <script type="text/javascript" src="/site_media/js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="/site_media/js/jquery-ui-1.8.16.custom.min.js"></script>
  <script type='text/javascript' src='/site_media/js/jquery.simplemodal.1.4.1.min.js'></script>
  <script type='text/javascript' src='/site_media/js/barcode-modals.js'></script>
  <script type="text/javascript" src="/site_media/js/jqueryFileTree.js"></script>
  <script type='text/javascript' src='/site_media/js/file-select-ops.js'></script>
  <script type="text/javascript" src="/site_media/js/visibility.js"></script>
  <script type="text/javascript" src="/site_media/js/checklist.js"></script>
  <script type="text/javascript" src="/site_media/js/record-check.js"></script>
  <script type="text/javascript" src="/site_media/js/component-select.js"></script>
  <script type="text/javascript" src="/site_media/js/licenses.js"></script>
</head>
{% endblock %}

{% block content %}

<div id="title">&nbsp;{% include "barcode/noscript.html" %}</div>

{% if error_message %}
    {% autoescape off %}
    <span class="red"><b>{{ error_message }}</b></span>
    {% endautoescape %}
{% endif %}

{% if not needs_setup %}
<form name="entryform" method="post" action="" enctype="multipart/form-data">
<div class="container" id="entry_form">
<table align="left" width="100%">
  <tr align="left">
    <td align="right"><b>{{ recordform.required_flag }}{{ recordform.company.label }}:</b></td>
    <td>{{ recordform.company }}</td>
    <td></td>
    <td>{{ recordform.company.errors }}</td>
  </tr>
  <tr align="left">
    <td align="right"><b>{{ recordform.required_flag }}{{ recordform.website.label }}:</b></td>
    <td>{{ recordform.website }}</td>
    <td></td>
    <td>{{ recordform.website.errors }}</td>
  </tr>
  <tr align="left">
    <td align="right"><b>{{ recordform.required_flag }}{{ recordform.product.label }}:</b></td>
    <td>{{ recordform.product }}</td>
    {% if products %}
      <td>
        <select id="id_product_select" onchange="select_to_product();">
          <option value="">Select...</option>
          <option value="manual_entry">New...</option>
          {% for p in products %}
            <option value="{{ p }}">{{ p }}</option>
          {% endfor %}
        </select>
      </td>
    {% endif %}
    <td>{{ recordform.product.errors }}</td>
  </tr>
  <tr align="left">
    <td align="right"><b>{{ recordform.required_flag }}{{ recordform.version.label }}:</b></td>
    <td>{{ recordform.version }}</td>
    <td></td>
    <td>{{ recordform.version.errors }}</td>
  </tr>
  <tr align="left">
    <td align="right"><b>{{ recordform.required_flag }}{{ recordform.release.label }}:</b></td>
    <td>{{ recordform.release }}</td>
    <td></td>
    <td>{{ recordform.release.errors }}</td>
  </tr>
  <tr align="left">
    <td align="right"><b>{{ recordform.optional_flag }}{{ recordform.contact.label }}:</b></td>
    <td>{{ recordform.contact }}</td>
    <td></td>
    <td></td>    
  </tr>
  <tr align="left">
    <td align="right"><b>{{ recordform.required_flag }}{{ recordform.email.label }}:</b></td>
    <td>{{ recordform.email }}</td>
    <td>
      {{ recordform.email.errors }}
    </td>
    <td></td>   
  </tr>
  <tr align="left">
    <td align="right"><b>{{ recordform.optional_flag }}{% autoescape off %}{{ recordform.spdx_file.label }}{% endautoescape %}:</b></td>
    <td>{{ recordform.spdx_file }}</td>
    <td align="center">
        <a href="#" id="clear_foss_spdx"><img src="/site_media/images/edit-delete.png" 
                    title="Clear SPDX" onclick="clear_spdx('id_spdx_file', 'foss_spdx_select');"></a>
        <input type="button" name="spdxfilename" value="Select" id="top_spdx_select"
                             title="Open a File/Directory Selector"
                             onclick="toggle_visibility('target_select');set_destination('spdx_file')"/>
    </td>
    <td></td>    
  </tr>
  <tr align="left">
    <td align="right"><b>{{ recordform.optional_flag }}{{ recordform.release_date.label }}:</b></td>
    <td>{{ recordform.release_date }}</td>
    <td></td>
    <td></td>    
  </tr>
  <tr align="left">
    <th>(Fields marked * are optional)</th>
    <td align="center">
      <input type="button" id="dupe_search" value="Continue..." onclick="search_dupes();">
    </td>    
    <td></td>
    <td></td>
  </tr>          
</table>
</div> <!-- entry_form -->

<div class="container" id="target_select" style="display: none;"> 
	<div id="target" class="browser"></div> 
</div>

<div class="foss_table">
{% if component_error %}
    {% autoescape off %}
    <span class="red"><b>{{ component_error }}</b></span>
    {% endautoescape %}
{% endif %}
<table border="1" width="700" cellspacing="1" id="foss_list">
    <col width=30>
    <col width=30>
    <col width=125>
    <col width=60>
    <col width=120>
    <col width=120>
    <col width=60>
    <col width=145>
    <col width=145>
    <col width=120>
    <col width=30>
    <col width=145>
    <col width=120>
  <tr>
    <td colspan="2"></td>
    <th>{{ recordform.required_flag }}Software<br>Component Name</th>
    <th>{{ recordform.required_flag }}{{ recordform.foss_version.label }}</th>
    <th>{{ recordform.required_flag }}Copyright<br>Information</th>
    <th>{{ recordform.required_flag }}Attribution<br>Notices</th>
    <th colspan="2">{{ recordform.required_flag }}License Name, Version and URL</th>
    <th>{{ recordform.required_flag }}Mint Version<br>Download URL</th>
    <td colspan="2" align="center">
        <b>SPDX<sup>TM</sup>File{{ recordform.optional_flag }}</b> 
        <input type="button" name="spdxfilename" value="Select" id="foss_spdx_select"
                             title="Open a File/Directory Selector"
                             onclick="toggle_visibility('target_select');set_destination('foss_spdx');toggle_enabled('patchfilename');"/>
    </td>
    <th>Patch Files{{ recordform.optional_flag }}</th>  
    <td></td>
  </tr>
  <tr>
    <td colspan="2"></td>
    <td colspan="7">{% autoescape off %}{{ component_select }}{% endautoescape %}</td>
    <td colspan="4"></td>
  </tr>
  <tr>
    <!-- needed to control the width here, so hand tweaked size in css -->
    <td colspan="2"></td>
    <td>{{ recordform.foss_component }}</td>
    <td>{{ recordform.foss_version }}</td>
    <td>{{ recordform.foss_copyright }}</td>
    <td>{{ recordform.foss_attribution }}</td>
    <td colspan="2">
      {{ recordform.foss_license }}<br>
      {{ recordform.foss_license_url }}
    </td>
    <td>{{ recordform.foss_url }}</td>
    <td>{{ recordform.foss_spdx }}</td>
    <td>
        <a href="#" id="clear_foss_spdx"><img src="/site_media/images/edit-delete.png" 
                    title="Clear SPDX" onclick="clear_spdx('id_foss_spdx', 'top_spdx_select');"></a>
    </td>
    <td align="center" colspan="2"><input type="button" name="addfoss" 
                                        value="Add Component" 
                                        onclick="get_bom_values();add_bom_row('foss_list', 'add')"/>
    </td>
  </tr>
  <tr id="bom_new_license" style="display: none;">
    <td colspan="6"></td>
    <td colspan="2">
      <form id="new_license_form">
        <label for="license_name">New License Name:</label>
        <input type="text" name="license_name" />
        <label for="license_version">New License Version:</label>
        <input type="text" name="license_version" />
        <input type="button" onclick="new_license()" value="Add New License" />
      </form>
    </td>
    <td colspan="5"></td>
  </tr>
  <tr id="bom_editor">
    <td align="left" colspan="2"><input type="checkbox" name="selectall"
                    title="Select/Deselect All Records" 
                    onclick="toggleall(this.form,'bomcheck','selectall')" />
    </td>
    <td colspan="9"></td>
    <td align="center" colspan="2"><input type="button" name="delete_rows" value="Delete Selected Components"
                onclick="delete_bom_components('foss_list')" />
    </td>
  </tr> <!-- editor -->
<!-- TODO - loop and fill this from SPDX? -->
</table>
</div> <!-- foss_table -->

<input type="hidden", name="foss_components", id="foss_components", value="{{ foss_components }}">
<input type="hidden", name="foss_versions", id="foss_versions", value="{{ foss_versions }}">
<input type="hidden", name="foss_copyrights", id="foss_copyrights", value="{{ foss_copyrights }}">
<input type="hidden", name="foss_attributions", id="foss_attributions", value="{{ foss_attributions }}">
<input type="hidden", name="foss_licenses", id="foss_licenses", value="{{ foss_licenses }}">
<input type="hidden", name="foss_license_urls", id="foss_license_urls", value="{{ foss_license_urls }}">
<input type="hidden", name="foss_urls", id="foss_urls", value="{{ foss_urls }}">
<input type="hidden", name="foss_spdxs", id="foss_spdxs", value="{{ foss_spdxs }}"> 
<input type="hidden", name="foss_patches", id="foss_patches", value="{{ foss_patches }}">

<div class="cfooter">
<hr>
<table width="100%" id="submit_buttons">
  <tr>
    <td align="center"><input style="width: 300px" type="submit" name="submit_code" 
                              value="Add Compliance Record" onclick="return enable_disabled();"/></td>
  </tr>
</table>
</form> <!-- overall form ends here to include the submit buttons -->
</div>

{% endif %}
<!-- this is the modal popup content for editing the line item data -->
{% include "barcode/edit_line_input.html" %}
{% endblock %}

{% block scripts %}
<script language="JavaScript">
    // datepicker for the release date
    $(function() {
        $( "#id_release_date" ).datepicker({
            dateFormat: 'yy-mm-dd',
            autoSize: true,
            showOn: "button",
            buttonImage: "/site_media/images/calendar.gif",
            buttonImageOnly: true
        });
    });
    // this gets used by component-select.js
    {% if cached_components %}
    var ccache = {% autoescape off %}{{ cached_components }}{% endautoescape %};
    {% endif %}

    // populate the license drop-down on load, and set up its events
    $("#id_foss_license").ready(function() {
        populate_licenses("id_foss_license");
        $("#id_foss_license").change(function() {
            if (this.value == '-1') {
                $('#license_name').val('');
                $('#license_version').val('');
                $('#bom_new_license').show();
            } else {
                $('#bom_new_license').hide();
            }
        });
    });

    // pfield, sfield, modal are defined in file-select-ops.js

    var header_fields = { "company": "",
                          "website": "",
                          "product": "",
                          "version": "",
                          "release": "",
                          "contact": "",
                          "email": "" };

    // order matters here - needs to be the same as the table columns
    var bom_fields = { "foss_component": "",
                       "foss_version": "", 
                       "foss_copyright": "", 
                       "foss_attribution": "",        
                       "foss_license": "", 
                       "foss_license_url": "", 
                       "foss_url": "", 
                       "foss_spdx": "" };

    function setdefaults() {
        // if the user submitted with missing data, we lose the FOSS table content, repopulate
        if (document.getElementById("foss_components").value != "") {
            var fossc = document.getElementById("foss_components").value.split(",");
            var fossp = document.getElementById(pfield).value.split(",");
            for (i = 0; i < fossc.length - 1; i++) {
                for(var f in bom_fields){
                    var fh = f + "s";
                    bom_fields[f] = document.getElementById(fh).value.split(",")[i];
                }                
                add_bom_row("foss_list", "reload");
                var patch_tag = pfield + i;
                var p = document.getElementsByName(patch_tag)[0];
                if (typeof p != 'undefined')
                    p.value = fossp[i];                
            }
        } else {
            hide_element("foss_list");
            hide_element("bom_editor");
            hide_element("submit_buttons");
        }
        // disable manual input for the spdx_file field
        document.getElementById("id_spdx_file").setAttribute("readonly", "true");
        document.getElementById("id_foss_spdx").setAttribute("readonly", "true");
        // content of this field determines what we can do with the line items
        document.getElementById("id_spdx_file").setAttribute("onchange", "spdx_change('id_spdx_file', 'foss_spdx_select');");
        // and the reverse is true
        document.getElementById("id_foss_spdx").setAttribute("onchange", "spdx_change('id_foss_spdx', 'top_spdx_select');");
        // prefill some header values if defined
        document.getElementById("id_company").setAttribute("value", "{% autoescape off %}{{ company_prefills.name }}{% endautoescape %}");
        document.getElementById("id_website").setAttribute("value", "{% autoescape off %}{{ company_prefills.website }}{% endautoescape %}");
        document.getElementById("id_contact").setAttribute("value", "{% autoescape off %}{{ company_prefills.contact }}{% endautoescape %}");
        document.getElementById("id_email").setAttribute("value", "{% autoescape off %}{{ company_prefills.email }}{% endautoescape %}");
        // default to list select
        {% if products %}
        document.getElementById("id_product").disabled = true;
        {% endif %}
        {% if cached_components %}
        component_disabled(true);
        {% endif %}
    }
    function select_to_product() {
        var product = document.getElementById("id_product_select").value;
        var dest = document.getElementById("id_product");
        if (product == "manual_entry") {
            dest.disabled = false;
        } else if (product == "") {
            return 0;
        } else {
            dest.value = product;
            dest.disabled = true;
            document.getElementById("id_product_select")[0].selected = true;
        }
    }
    function enable_disabled() {
        // django doesn't see the entered values for disabled fields on submit, enable them before submit
        document.getElementById("id_product").disabled = false;
        return true;
    }
    function update_patch_list(src) {
        var findex = src.replace(pfield, "");
        var rlist = document.getElementById(pfield).value;
        var rarray = rlist.split(",");
        rarray[findex] = document.getElementsByName(src)[0].value;
        document.getElementById(pfield).value = rarray.join(",");        
    }
    function get_bom_values() {
        for(var f in bom_fields){
            bom_fields[f] = document.getElementsByName(f)[0].value;
        }    
    }
    function remove_bom_values(row) {
        for(var f in bom_fields){
            var fh = f + "s";
            var rlist = document.getElementById(fh).value;
            var rarray = rlist.split(",");
            rarray.splice(row,1);
            document.getElementById(fh).value = rarray.join(",");
        } 
    }
    function replace_bom_values(row) {
        // called from the modal line-item change dialog
        for(var f in bom_fields){
            var fh = f + "s";
            var src = "id_m_" + f;
            var dest = f + row;
            document.getElementById(dest).innerHTML = document.getElementById(src).value; 
            var rlist = document.getElementById(fh).value;
            var rarray = rlist.split(",");
            // table is 1-indexed, hidden lists are zero indexed
            rarray[row] = document.getElementById(src).value;
            document.getElementById(fh).value = rarray.join(",");
        }
        // and the patches
        var src = "id_m_" + pfield;
        var dest = "id_" + pfield + row;
        document.getElementById(dest).value = document.getElementById(src).value;
    }
    function clear_bom_values() {
        for(var f in bom_fields){
            var fh = f + "s";
            document.getElementById(fh).value = "";
        }
    }
    function delete_bom_components(id) {
        // nothing is in the database yet, so this is handled a little differently than the other forms
        var t = document.getElementById(id);
        var chk = document.getElementsByName("bomcheck");
        // list index is 0... - actual row is +4     
        if (typeof chk != 'undefined') {
            if (typeof chk.length != 'undefined') {
                // work backwords or we miss rows
                for (i = chk.length - 1; i >= 0; i--) {
                    if (chk[i].checked == true) {
                        t.deleteRow(i + 4);
                        remove_bom_values(i);
                    }
                }
            } else {
                // only one row to work with
                if (chk.checked == true) {
                    t.deleteRow(4);
                    clear_bom_values();
                }
            }
            document.getElementsByName("selectall")[0].checked = false;
            hide_element("bom_editor");
        } else {
            return;
        }
    }
    function add_bom_row(id, mode){
        var filled = true;
        for(var f in bom_fields){
            if ((bom_fields[f]) == "" && (f != sfield))
                filled = false;
        } 
        // refuse to add unless all required fields are filled       
        if ((mode == "add") && (filled == false)) {       
            alert("Please fill all required component fields.");
            return;
        }

        var tbody = document.getElementById(id).getElementsByTagName("TBODY")[0];
        var rindex = document.getElementById(id).rows.length - 4;
        var patch_tag = pfield + rindex;
        var row = document.createElement("TR");

        // checkbox for deletes
        var td0 = document.createElement("TD");
        var tcb = document.createElement("input");
        tcb.setAttribute("type", "checkbox");
        tcb.setAttribute("name", "bomcheck");
        var chk = document.getElementsByName("bomcheck");
        var cvalue = 0;        
        if (typeof chk != 'undefined') {
            if (typeof chk.length != 'undefined')
                cvalue = chk.length;
        }
        tcb.setAttribute("value", cvalue);
        td0.appendChild(tcb);
        row.appendChild(td0);

        // icon for editing a line
        var td1 = document.createElement("TD");
        var tdd = document.createElement("div");
        tdd.setAttribute("id", "line-item-modal");
        var tda = document.createElement("a");
        tda.setAttribute("href", "#");
        tda.setAttribute("class", "basic");
        tda.setAttribute("name", "line_item" + cvalue);
        tda.setAttribute("id", cvalue);
        // for some reason, dynamically added modal triggers don't activate the model, use onclick
        tda.setAttribute("onclick", "line_edit_init(" + cvalue + ");");
        var tdi = document.createElement("img");
        tdi.setAttribute("src", "/site_media/images/filetree/edit.png");
        tdi.setAttribute("title", "Edit Line Item");
        tda.appendChild(tdi);
        tdd.appendChild(tda);
        td1.appendChild(tdd);
        row.appendChild(td1);

        // all text fields, just loop through input object
        for(var f in bom_fields){
            var td = document.createElement("TD");
            td.setAttribute("valign", "top");
            td.setAttribute("id", f + cvalue);
            if (f == sfield)
                td.setAttribute("colspan", "2");
            td.appendChild(document.createTextNode(bom_fields[f]));
            row.appendChild(td);
        }

        // list of patches
        var td9 = document.createElement("TD");        
        var ch9 = document.createElement("textarea");
        ch9.setAttribute("type", "textarea");
        ch9.setAttribute("id", "id_" + patch_tag);
        ch9.setAttribute("name", patch_tag);
        ch9.setAttribute("readonly", "true");
        td9.appendChild(ch9);   
        row.appendChild(td9);

        // buttons for file selectors
        var td10 = document.createElement("TD");
        td10.setAttribute("align", "center");
        var ch10 = document.createElement("input");
        ch10.setAttribute("type", "button");
        ch10.setAttribute("value", "Select\nPatch(es)");
        ch10.setAttribute("onclick", "toggle_visibility('target_select');toggle_enabled('spdxfilename');set_destination('" + patch_tag + "')");
        ch10.setAttribute("name","patchfilename");
        ch10.setAttribute("title", "Open a File/Directory Selector");
        td10.appendChild(ch10);
        row.appendChild(td10);
        
        tbody.appendChild(row);

        // only set the hidden fields for a clean add, not a form reload
        if (mode == "add") {
            // append to the hidden fields, clean the input fields
            for(var f in bom_fields){
                var fh = f + "s";
                document.getElementById(fh).value += bom_fields[f] + ",";
                document.getElementsByName(f)[0].value = "";
            }
        }

        // cleanup the input object
        for(var f in bom_fields){
            bom_fields[f] = "";
        }
        
        // show our "select all" controls
        show_none("bom_editor");
    }

    function line_edit_fill(row) {
        document.getElementById('line_item_no').innerHTML = row;
        // walk through the table row and plug the values into the edit form, called when we click the icon, before the form appears
        for(var f in bom_fields){
            var dest = "id_m_" + f;
            var src = f + row;
            if (document.getElementById(src).children.length > 0) {
                document.getElementById(dest).value = document.getElementById(src).children[0].innerHTML;
            } else {
                document.getElementById(dest).value = document.getElementById(src).innerHTML;
            }
        }
        // and the patches
        var dest = "id_m_" + pfield;
        var src = "id_" + pfield + row;
        document.getElementById(dest).value = document.getElementById(src).value;
    }

    function line_edit_init(row) {
        // FIXME - for some reason, the dynamically added icons never trigger $('#line-item-modal .basic').click
        // so we basically dupe the jQuery code here 
        // (calling $('#line-item-modal .basic').click() directly triggers recursion issues in chrome)
        line_edit_fill(row);
        $('#line-item-modal-content').modal({
             containerCss:{
                 height:450,
                 padding:0,
                 width:750
             }
        });
    }

    function line_validate_change() {
        var filled = true;
        for(var f in bom_fields){
            var src = "id_m_" + f;
            if (document.getElementById(src).value == "" && f != "foss_spdx" && f != "foss_patches")
                filled = false;
        }
        // refuse to submit unless all required fields are filled       
        if (filled == false) {      
            alert("Please fill all required component fields, including the commit message");
        } else {
            // plug the values back into the table row and the hidden field
            var row = document.getElementById('line_item_no').innerHTML;
            replace_bom_values(row);
            // close the modal dialog
            $.modal.close();
        }
    }

    function search_dupes() {
        var filled = true;
        for(var f in header_fields){
            var src = "id_" + f;
            if (document.getElementById(src).value == "" && f != "contact")
                filled = false;
        }
        // refuse to continue unless all required fields are filled       
        if (filled == false) {      
            alert("Please fill all required header fields");
        } else {
            var record = check_for_record();
            if (record == "None") {
                show_none("foss_list");
                show_none("submit_buttons");
                hide_element("dupe_search");
            } else {
                var answer = confirm("There appears to already be an entry with that company, product, version, release. Would you care to edit that entry instead?")
	            if (answer)
		            window.location = "/barcode/" + record + "/detail/";
            }
        }
    }
    function spdx_change(tid, sid) {
        // tid = input field changed, sid = other file select button to disable
        var e = document.getElementById(sid);  
        if (typeof e != 'undefined') {
            if (document.getElementById(tid).value == '') {
                // disable the "other" spdx selector
                e.disabled = false;
                // hide the file selector if it's open
                hide_element("target_select");
            } else {
                e.disabled = true;
                // if we set the top-level one, clear all the line item entries
                if (sid.search("foss") != -1) {
                    var rowcount = document.getElementById("foss_list").getElementsByTagName("TR").length;
                    for (i = 0; i < rowcount - 3; i++) {
                        cell_id = "foss_spdx" + i;
                        document.getElementById(cell_id).innerHTML = ''
                    }
                }
            }
        }
    }
    function clear_spdx(tid, sid) {
        document.getElementById(tid).value = '';
        spdx_change(tid, sid);
    }
    function clear_field(fname) {
        document.getElementById(fname).value = '';
    }

    function new_license() {
        var new_license_name = $('#license_name').val();
        var new_license_version = $('#license_version').val();
        create_new_license(new_license_name, new_license_version,
            function(new_license_id) {
                populate_licenses('id_foss_license');
                select_license('id_foss_license', new_license_id);
            });
    }
</script>
{% endblock %}

